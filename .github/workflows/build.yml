name: Build Android APK/AAB

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # Ø§ÙØ²Ø§ÛŒØ´ Ø²Ù…Ø§Ù† ØªØ§ÛŒÙ…â€ŒØ§ÙˆØª Ù¾Ø§ÛŒØªÙˆÙ† Ø¨Ø±Ø§ÛŒ Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§ÛŒ Ø³Ù†Ú¯ÛŒÙ†
      PYTHON_FOR_ANDROID_THREAD_TIMEOUT: 600
      # Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ú©Ø±Ø± Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§
      PYTHON_FOR_ANDROID_IGNORE_FATAL_ERRORS: 1
      
    steps:
    - name: ğŸ“ Checkout code
      uses: actions/checkout@v4 

    - name: ğŸ“¦ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ› ï¸ Install dependencies for Buildozer & Cython
      run: |
        sudo apt-get update
        sudo apt-get install -y git zip unzip openjdk-17-jdk python3-pip autoconf libtool pkg-config zlib1g-dev libncursesw5-dev cmake
        pip install cython buildozer

    - name: ğŸ”‘ Accept Android SDK Licenses
      # Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø§Ø®ØªØ§Ø± Ù¾ÙˆØ´Ù‡ Ù„Ø§ÛŒØ³Ù†Ø³ Ùˆ ÛŒÚ© ÙØ§ÛŒÙ„ Ø´Ø§Ù…Ù„ Ù‡Ø´ Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯Ù‡ 
      # Ø§ÛŒÙ† Ú©Ø§Ø± Ø³ÛŒØ³ØªÙ… Ø±Ø§ ÙØ±ÛŒØ¨ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ú©Ù‡ Ù„Ø§ÛŒØ³Ù†Ø³â€ŒÙ‡Ø§ Ù‚Ø¨ÙˆÙ„ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯ Ùˆ Ø¨ÛŒÙ„Ø¯ Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒÛŒØ§Ø¨Ø¯.
      run: |
        mkdir -p $HOME/.buildozer/android/platform/android-sdk/licenses
        echo -e "84831b94d134096996d9c67be85a9ac578393a57\nd975a6d71686985d8866d9299443e06a928e4604\n5046298ac9856f1dbf31920d3b664747f87f0c13\n85539446e0ca86980e0f1a39626576204c4075b0\n24333f8a63b6825ea9c5514f83c2829b004d1fee" > $HOME/.buildozer/android/platform/android-sdk/licenses/android-sdk-license

    - name: âš™ï¸ Set execution permissions
      run: chmod +x buildozer.spec

    - name: ğŸ”¨ Run Buildozer (Debug Build)
      run: buildozer android debug
      
    - name: â¬†ï¸ Upload APK artifact
      uses: actions/upload-artifact@v4 
      with:
        name: ${{ github.event.repository.name }}-${{ github.run_number }}-apk
        path: bin/*.apk
        
    - name: ğŸ“¦ Create GitHub Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        files: bin/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
