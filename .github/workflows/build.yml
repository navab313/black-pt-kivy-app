name: Build Android APK/AAB

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

# --- ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ Ú©Ù„ÛŒ Ø¯Ø± Ø³Ø·Ø­ Workflow ---
# Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ø§Ù„Ø§ØªØ±ÛŒÙ† Ø³Ø·Ø­ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ù…Ú©Ù† (write) Ø±Ø§ Ø¨Ø±Ø§ÛŒ ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø®Ø²Ù† (contents, packages, issues, etc.) ÙØ±Ø§Ù‡Ù… Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
permissions:
  contents: write
  packages: write
  pull-requests: write
  # Ø§Ú¯Ø±Ú†Ù‡ Ø¨Ø±Ø§ÛŒ Ø¨ÛŒÙ„Ø¯ Ø¶Ø±ÙˆØ±ÛŒ Ù†ÛŒØ³ØªÙ†Ø¯ØŒ Ø§Ù…Ø§ Ø³Ø·Ø­ Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø§ Ú©Ø§Ù…Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯:
  statuses: write
  checks: write
  id-token: write
  security-events: write
  
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PYTHON_FOR_ANDROID_THREAD_TIMEOUT: 600
      PYTHON_FOR_ANDROID_IGNORE_FATAL_ERRORS: 1
      
    steps:
    - name: ğŸ“ Checkout code
      uses: actions/checkout@v4 

    - name: ğŸ“¦ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ› ï¸ Install dependencies for Buildozer & Cython
      # Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ zip/unzip/unrar Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§ÛŒ buildozer
      run: |
        sudo apt-get update
        sudo apt-get install -y git zip unzip unrar openjdk-17-jdk python3-pip autoconf libtool pkg-config zlib1g-dev libncursesw5-dev cmake
        pip install cython buildozer

    - name: ğŸ”‘ Accept Android SDK Licenses and Prepare Structure
      # Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ SDK Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ùˆ Ù¾Ø°ÛŒØ±Ø´ Ù…Ø¬ÙˆØ²Ù‡Ø§ Ø¨Ø±Ø§ÛŒ SDK Ùˆ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ø®Ø· ÙØ±Ù…Ø§Ù†
      run: |
        SDK_ROOT=$HOME/.buildozer/android/platform/android-sdk
        mkdir -p $SDK_ROOT/licenses
        # 1. Ù†ØµØ¨ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ø®Ø· ÙØ±Ù…Ø§Ù† (cmdline-tools)
        $SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "cmdline-tools;latest"
        
        # 2. Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø§Ø®ØªØ§Ø± ÙÙˆÙ„Ø¯Ø± Ù‚Ø¯ÛŒÙ…ÛŒ Ùˆ Symlink
        mkdir -p $SDK_ROOT/tools/bin  # Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø³ÛŒØ± Ù‚Ø¯ÛŒÙ…ÛŒ Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø± ØªÙˆØ³Ø· P4A
        # Ù¾ÛŒÙˆÙ†Ø¯ Ø¯Ø§Ø¯Ù† sdkmanager ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ù‡ Ù…Ø³ÛŒØ± Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø± Buildozer
        ln -s $SDK_ROOT/cmdline-tools/latest/bin/sdkmanager $SDK_ROOT/tools/bin/sdkmanager
        
        # 3. Ù¾Ø°ÛŒØ±Ø´ Ù…Ø¬ÙˆØ²Ù‡Ø§ (Ù…Ø§Ù†Ù†Ø¯ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„)
        echo -e "84831b94d134096996d9c67be85a9ac578393a57\nd975a6d71686985d8866d9299443e06a928e4604\n5046298ac9856f1dbf31920d3b664747f87f0c13\n85539446e0ca86980e0f1a39626576204c4075b0\n24333f8a63b6825ea9c5514f83c2829b004d1fee\nd56f5187479451e5792070366a5e903d62325516" > $SDK_ROOT/licenses/android-sdk-license
        echo -e "84831b94d134096996d9c67be85a9ac578393a57" > $SDK_ROOT/licenses/android-sdk-preview-license

    - name: âš™ï¸ Set execution permissions
      run: chmod +x buildozer.spec

    - name: ğŸ”¨ Run Buildozer (Debug Build)
      run: buildozer android debug
      
    - name: â¬†ï¸ Upload APK artifact
      uses: actions/upload-artifact@v4 
      with:
        name: ${{ github.event.repository.name }}-${{ github.run_number }}-apk
        path: bin/*.apk
        
    - name: ğŸ“¦ Create GitHub Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        files: bin/*.apk
        draft: false
        prerelease: false
      env:
        # GITHUB_TOKEN Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø­Ø§Ù„Ø§ Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ write Ø±Ø§ Ø¯Ø§Ø±Ø¯
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
