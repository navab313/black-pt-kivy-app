name: ðŸ—ï¸ Build Android APK with Docker

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
        - debug
        - release

permissions:
  contents: write
  packages: write
  deployments: write

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    strategy:
      matrix:
        python-version: ["3.10"]
        architecture: ["arm64-v8a"]
    
    steps:
    # Ù…Ø±Ø­Ù„Ù‡ 1: Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive

    # Ù…Ø±Ø­Ù„Ù‡ 2: Ø³Ø§Ø®Øª APK Ø¨Ø§ Docker (Ø±Ø§Ù‡ Ø­Ù„ Ø§ØµÙ„ÛŒ)
    - name: ðŸ³ Build APK using Docker
      id: build
      run: |
        echo "ðŸš€ Starting Docker build process..."
        
        # Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ
        rm -rf .buildozer bin *.apk *.aab
        
        # Ø³Ø§Ø®ØªØ§Ø± Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ
        mkdir -p data fonts
        
        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ
        if [ ! -f "main.py" ]; then
          echo "âŒ Error: main.py not found!"
          exit 1
        fi
        
        if [ ! -f "buildozer.spec" ]; then
          echo "âš ï¸ Creating default buildozer.spec..."
          cat > buildozer.spec << 'EOF'
        [app]
        title = Grade Predictor
        package.name = gradepredictor
        package.domain = com.mycompany
        version = 1.0.0
        main.py = main.py
        source.dir = .
        source.include_exts = py,png,jpg,kv,ttf
        source.include_dirs = fonts,data
        icon.filename = data/icon.png
        presplash.filename = data/splash.png
        requirements = python3,kivy,arabic-reshaper,python-bidi
        android.permissions = INTERNET
        android.api = 33
        android.minapi = 21
        android.archs = arm64-v8a
        android.ndk = 25b
        p4a.bootstrap = sdl2
        orientation = portrait
        log_level = 2
        EOF
                fi
        
        # Ø§Ø¬Ø±Ø§ÛŒ Buildozer Ø¯Ø± Docker
        echo "ðŸ³ Running Buildozer in Docker..."
        
        # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Docker image Ø±Ø³Ù…ÛŒ Kivy
        docker run --rm \
          --workdir /app \
          --volume "$(pwd)":/app \
          --volume "/tmp/.buildozer":/root/.buildozer \
          --env BUILDOZER_ANDROID_ACCEPT_LICENSES=yes \
          --env P4A_RELEASE_KEYSTORE_PASSWD=dummy \
          --env P4A_RELEASE_KEYALIAS_PASSWD=dummy \
          kivy/buildozer \
          android clean update debug 2>&1 | tee docker_build.log
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ù†ØªÛŒØ¬Ù‡ Ø³Ø§Ø®Øª
        if [ $? -eq 0 ]; then
          echo "âœ… Docker build completed successfully"
        else
          echo "âŒ Docker build failed"
          echo "=== Last 50 lines of Docker log ==="
          tail -50 docker_build.log
          exit 1
        fi

    # Ù…Ø±Ø­Ù„Ù‡ 3: Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„ APK Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡
    - name: ðŸ” Verify APK file
      id: verify
      run: |
        echo "ðŸ” Verifying APK files..."
        
        # Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„ APK
        APK_FILES=$(find . -name "*.apk" -type f)
        
        if [ -z "$APK_FILES" ]; then
          echo "âŒ No APK files found!"
          echo "Searching in bin directory..."
          ls -la bin/ 2>/dev/null || echo "bin directory doesn't exist"
          
          # Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ú©Ù„ Ù¾Ø±ÙˆÚ˜Ù‡
          echo "Searching in entire project..."
          find . -type f -name "*.apk" 2>/dev/null || echo "No APK files found anywhere"
          exit 1
        fi
        
        # Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª APK
        for APK in $APK_FILES; do
          echo "âœ… Found APK: $APK"
          echo "ðŸ“ Size: $(du -h "$APK" | cut -f1)"
          echo "ðŸ“… Modified: $(stat -c %y "$APK")"
        done
        
        # Ú©Ù¾ÛŒ APK Ø¨Ù‡ Ù†Ø§Ù… Ø³Ø§Ø¯Ù‡
        MAIN_APK=$(echo "$APK_FILES" | head -1)
        cp "$MAIN_APK" ./app-debug.apk 2>/dev/null || true
        
        echo "APK_COUNT=$(echo "$APK_FILES" | wc -l)" >> $GITHUB_OUTPUT

    # Ù…Ø±Ø­Ù„Ù‡ 4: Ø¢Ù¾Ù„ÙˆØ¯ APK Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Artifact
    - name: ðŸ“¤ Upload APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: grade-predictor-apk
        path: |
          bin/*.apk
          app-debug.apk
          *.apk
        if-no-files-found: error
        retention-days: 30
        overwrite: true
        compression-level: 0

    # Ù…Ø±Ø­Ù„Ù‡ 5: Ø¢Ù¾Ù„ÙˆØ¯ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø®Øª
    - name: ðŸ“ Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          docker_build.log
          *.log
          .buildozer/**/*.log
        retention-days: 7
        if-no-files-found: ignore
        compression-level: 0

    # Ù…Ø±Ø­Ù„Ù‡ 6: Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Buildozer Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯
    - name: ðŸ› Upload Buildozer files for debugging
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: buildozer-debug
        path: |
          .buildozer/
          buildozer.spec
          requirements.txt
          pyproject.toml
        retention-days: 3
        if-no-files-found: ignore

    # Ù…Ø±Ø­Ù„Ù‡ 7: Ø§ÛŒØ¬Ø§Ø¯ Release Ø¯Ø± GitHub (ÙÙ‚Ø· Ø¯Ø± main/master)
    - name: ðŸ·ï¸ Create GitHub Release
      if: success() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }} - Grade Predictor
        body: |
          # ðŸš€ Grade Predictor APK
          
          **Ø³Ø§Ø®Øª Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² APK Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯**
          
          ## ðŸ“‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ø§Ø®Øª
          - **Ø´Ù…Ø§Ø±Ù‡ Ø³Ø§Ø®Øª:** ${{ github.run_number }}
          - **Ú©Ø§Ù…ÛŒØª:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          - **ØªØ§Ø±ÛŒØ® Ø³Ø§Ø®Øª:** $(date +'%Y/%m/%d - %H:%M:%S')
          - **Ø´Ø§Ø®Ù‡:** ${{ github.ref_name }}
          - **Ù…Ø¹Ù…Ø§Ø±ÛŒ:** arm64-v8a
          
          ## ðŸ“± Ù†Ø­ÙˆÙ‡ Ù†ØµØ¨
          1. ÙØ§ÛŒÙ„ APK Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯
          2. Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú¯ÙˆØ´ÛŒ Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ Ø¨Ù‡ **Settings â†’ Security** Ø¨Ø±ÙˆÛŒØ¯
          3. Ú¯Ø²ÛŒÙ†Ù‡ **"Unknown Sources"** ÛŒØ§ **"Install unknown apps"** Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯
          4. ÙØ§ÛŒÙ„ APK Ø±Ø§ Ø§Ø¬Ø±Ø§ Ùˆ Ù†ØµØ¨ Ú©Ù†ÛŒØ¯
          
          ## ðŸ”§ Ù…Ø´Ø®ØµØ§Øª ÙÙ†ÛŒ
          - **Build Tool:** Buildozer Ø¨Ø§ Docker
          - **Python Version:** 3.10
          - **Android API:** 33
          - **Android NDK:** 25b
          - **Kivy Version:** 2.3.0
          
          ## ðŸ“„ ØªØºÛŒÛŒØ±Ø§Øª
          ```bash
          ${{ github.event.head_commit.message }}
          ```
          
          ## ðŸ› Ú¯Ø²Ø§Ø±Ø´ Ù…Ø´Ú©Ù„
          Ø§Ú¯Ø± Ø¨Ø§ Ù…Ø´Ú©Ù„ÛŒ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯ÛŒØ¯ØŒ Ù„Ø·ÙØ§Ù‹ Ø¯Ø± [Issues](https://github.com/${{ github.repository }}/issues) Ú¯Ø²Ø§Ø±Ø´ Ø¯Ù‡ÛŒØ¯.
          
          ## ðŸ¤ Ù…Ø´Ø§Ø±Ú©Øª
          Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ø±Ú©Øª Ø¯Ø± ØªÙˆØ³Ø¹Ù‡ØŒ Ø±ÛŒÙ¾Ùˆ Ø±Ø§ fork Ú©Ù†ÛŒØ¯ Ùˆ Pull Request Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.
          
          ---
          *Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§ â¤ï¸ Ùˆ GitHub Actions*
          
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          bin/*.apk
          app-debug.apk
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Ù…Ø±Ø­Ù„Ù‡ 8: Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙÙ‚ÛŒØª
    - name: âœ… Success notification
      if: success()
      run: |
        echo "ðŸŽ‰ ========================================="
        echo "ðŸŽ‰ BUILD SUCCESSFUL!"
        echo "ðŸŽ‰ ========================================="
        echo ""
        echo "ðŸ“± APK files are available in:"
        echo "   1. Artifacts section (grade-predictor-apk)"
        echo "   2. Releases section (v${{ github.run_number }})"
        echo ""
        echo "â±ï¸  Build time: $(date)"
        echo "ðŸ”— Repository: https://github.com/${{ github.repository }}"
        echo ""

    # Ù…Ø±Ø­Ù„Ù‡ 9: Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø´Ú©Ø³Øª
    - name: âŒ Failure notification
      if: failure()
      run: |
        echo "âŒ ========================================="
        echo "âŒ BUILD FAILED!"
        echo "âŒ ========================================="
        echo ""
        echo "ðŸ”§ Possible issues:"
        echo "   1. Missing main.py or buildozer.spec"
        echo "   2. Network issues during Docker pull"
        echo "   3. Android SDK/NDK download failed"
        echo "   4. Insufficient disk space"
        echo ""
        echo "ðŸ“‹ Check the following artifacts for logs:"
        echo "   1. build-logs"
        echo "   2. buildozer-debug (if available)"
        echo ""
        echo "ðŸ› ï¸  Troubleshooting steps:"
        echo "   1. Verify main.py exists"
        echo "   2. Check buildozer.spec syntax"
        echo "   3. Ensure data/ and fonts/ directories exist"
        echo "   4. Try running locally with:"
        echo "      docker run --rm -v \$(pwd):/app kivy/buildozer android debug"
        echo ""

    # Ù…Ø±Ø­Ù„Ù‡ 10: Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ
    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up temporary files..."
        # Ø­ÙØ¸ Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ùˆ APKâ€ŒÙ‡Ø§ØŒ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙ‚Øª
        rm -rf .buildozer/android/platform/build-*/.gradle 2>/dev/null || true
        rm -rf .buildozer/android/platform/build-*/build 2>/dev/null || true
        echo "Cleanup completed"
