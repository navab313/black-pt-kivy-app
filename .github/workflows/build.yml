name: ğŸ—ï¸ Build Android APK (Manual P4A)

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ğŸ“¦ Install system dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          python3-pip python3-dev \
          git wget curl unzip zip \
          openjdk-17-jdk \
          zlib1g-dev libffi-dev libssl-dev

    - name: ğŸ”§ Install Buildozer
      run: |
        pip install buildozer==1.5.0 cython==0.29.36 virtualenv

    - name: ğŸ“¥ Download python-for-android manually
      run: |
        echo "ğŸ“¥ Downloading python-for-android..."
        
        # Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ
        rm -rf .buildozer
        
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ python-for-android
        wget -q https://github.com/kivy/python-for-android/archive/refs/tags/2023.10.06.tar.gz -O p4a.tar.gz
        mkdir -p .buildozer/android/platform
        tar -xzf p4a.tar.gz -C .buildozer/android/platform/
        mv .buildozer/android/platform/python-for-android-2023.10.06 .buildozer/android/platform/python-for-android
        rm p4a.tar.gz
        
        echo "âœ… python-for-android downloaded"

    - name: ğŸ“¥ Download Android NDK manually
      run: |
        echo "ğŸ“¥ Downloading Android NDK..."
        wget -q https://dl.google.com/android/repository/android-ndk-r25b-linux.zip -O ndk.zip
        mkdir -p .buildozer/android/platform
        unzip -q ndk.zip -d .buildozer/android/platform/
        mv .buildozer/android/platform/android-ndk-r25b .buildozer/android/platform/android-ndk
        rm ndk.zip
        
        echo "âœ… NDK downloaded"

    - name: ğŸ“ Create buildozer.spec
      run: |
        if [ ! -f "buildozer.spec" ]; then
          cat > buildozer.spec << 'EOF'
        [app]
        title = Grade Predictor
        package.name = gradepredictor
        package.domain = com.mycompany
        version = 1.0.0
        main.py = main.py
        source.dir = .
        source.include_exts = py,png,jpg,kv,ttf
        source.include_dirs = fonts,data
        icon.filename = data/icon.png
        presplash.filename = data/splash.png
        requirements = python3,kivy
        android.permissions = INTERNET
        android.api = 33
        android.minapi = 21
        android.archs = arm64-v8a
        android.ndk = 25b
        android.sdk = 33
        p4a.bootstrap = sdl2
        orientation = portrait
        log_level = 2
        EOF
                fi
                
        # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ
        mkdir -p data fonts bin
        echo "Placeholder" > data/icon.png
        echo "Placeholder" > data/splash.png
        echo "Placeholder" > fonts/farsi.ttf

    - name: ğŸ—ï¸ Build APK
      env:
        BUILDOZER_ANDROID_ACCEPT_LICENSES: yes
        ANDROID_HOME: /usr/local/lib/android/sdk
        ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      run: |
        echo "ğŸš€ Building APK..."
        
        # ØªÙ†Ø¸ÛŒÙ… Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ø¯Ø³ØªÛŒ
        export ANDROID_NDK_HOME=$(pwd)/.buildozer/android/platform/android-ndk
        export PATH=$PATH:$ANDROID_NDK_HOME
        
        # Ø³Ø§Ø®Øª APK
        buildozer -v android debug 2>&1 | tee build.log
        
        # Ø¨Ø±Ø±Ø³ÛŒ APK
        if ls bin/*.apk 1>/dev/null 2>&1; then
          echo "âœ… APK built!"
          ls -la bin/*.apk
        else
          echo "âŒ Build failed"
          echo "=== Log tail ==="
          tail -100 build.log
          exit 1
        fi

    - name: ğŸ“¤ Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-apk
        path: bin/*.apk
        if-no-files-found: error
