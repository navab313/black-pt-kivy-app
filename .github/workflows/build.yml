name: Build APK

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y python3-pip python3-venv git zip unzip openjdk-17-jdk
        pip install buildozer cython kivy
    
    - name: Create minimal files
      run: |
        mkdir -p data fonts bin
        if [ ! -f "buildozer.spec" ]; then
          cat > buildozer.spec << 'EOF'
        [app]
        title=MyApp
        package.name=myapp
        version=1.0
        main.py=main.py
        requirements=python3,kivy
        android.archs=arm64-v8a
        android.api=33
        android.ndk=25b
        EOF
                fi
                
        echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" | base64 -d > data/icon.png
        echo "Placeholder" > fonts/farsi.ttf
    
    - name: Build APK
      env:
        BUILDOZER_ANDROID_ACCEPT_LICENSES: yes
      run: |
        buildozer android clean
        buildozer android debug
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app
        path: bin/*.apk
