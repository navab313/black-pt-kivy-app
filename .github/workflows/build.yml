name: ğŸ—ï¸ Build Android APK

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  BUILDOZER_ANDROID_ACCEPT_LICENSES: yes
  P4A_RELEASE_KEYSTORE_PASSWD: dummy
  P4A_RELEASE_KEYALIAS_PASSWD: dummy

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    
    steps:
    # Step 1: Checkout code
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    # Step 2: Setup Python with caching
    - name: ğŸ Setup Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    # Step 3: Install system dependencies
    - name: ğŸ“¦ Install system dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          git wget curl unzip zip \
          openjdk-17-jdk \
          python3-pip python3-venv \
          autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev \
          libncursesw5-dev cmake \
          libffi-dev libssl-dev

    # Step 4: Install Python packages
    - name: ğŸ”§ Install Python packages
      run: |
        pip install --upgrade pip wheel setuptools
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          pip install buildozer cython
        fi

    # Step 5: Setup Android SDK licenses
    - name: âœ… Setup Android licenses
      run: |
        mkdir -p ~/.android/licenses
        echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > ~/.android/licenses/android-sdk-license
        echo "d56f5187479451e5792070366a5e903d62325516" >> ~/.android/licenses/android-sdk-license
        echo "84831b94d134096996d9c67be85a9ac578393a57" >> ~/.android/licenses/android-sdk-license

    # Step 6: Clean previous builds
    - name: ğŸ§¹ Clean previous builds
      run: |
        rm -rf .buildozer bin __pycache__ *.pyc *.log
        echo "Cleanup completed"

    # Step 7: Create required directories
    - name: ğŸ“ Create required directories
      run: |
        mkdir -p data fonts bin
        touch data/icon.png 2>/dev/null || true
        touch data/splash.png 2>/dev/null || true
        touch fonts/farsi.ttf 2>/dev/null || true

    # Step 8: Build APK with Buildozer
    - name: ğŸ—ï¸ Build APK with Buildozer
      run: |
        echo "ğŸš€ Starting Buildozer build process..."
        
        # Clean and update
        buildozer android clean
        buildozer android update
        
        # Build with detailed logging
        buildozer -v android debug 2>&1 | tee build.log
        
        # Check build status
        if [ $? -eq 0 ]; then
          echo "âœ… Build completed successfully"
        else
          echo "âŒ Build failed"
          echo "=== Build log errors ==="
          grep -i "error\|fail\|exception" build.log | head -20
          exit 1
        fi

    # Step 9: Verify APK file
    - name: ğŸ” Verify APK file
      run: |
        APK_FILES=$(find bin -name "*.apk" -type f 2>/dev/null)
        
        if [ -n "$APK_FILES" ]; then
          APK_FILE=$(echo "$APK_FILES" | head -1)
          echo "âœ… APK found: $APK_FILE"
          echo "ğŸ“ Size: $(du -h "$APK_FILE" | cut -f1)"
          echo "ğŸ“ All APK files:"
          ls -la bin/*.apk 2>/dev/null || echo "No APK files in bin directory"
        else
          echo "âŒ No APK file found!"
          echo "Contents of bin directory:"
          ls -la bin/ 2>/dev/null || echo "bin directory doesn't exist"
          exit 1
        fi

    # Step 10: Upload APK artifact
    - name: ğŸ“¤ Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: grade-predictor-apk
        path: bin/*.apk
        if-no-files-found: error
        retention-days: 30

    # Step 11: Create GitHub Release
    - name: ğŸ·ï¸ Create GitHub Release
      if: success() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        body: |
          APK Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Grade Predictor
          
          **Ù…Ø´Ø®ØµØ§Øª:**
          - Ø´Ù…Ø§Ø±Ù‡ Ø³Ø§Ø®Øª: ${{ github.run_number }}
          - Ú©Ø§Ù…ÛŒØª: ${{ github.sha }}
          - ØªØ§Ø±ÛŒØ®: $(date +'%Y-%m-%d %H:%M:%S')
          
          **Ù†Ø­ÙˆÙ‡ Ù†ØµØ¨:**
          1. ÙØ§ÛŒÙ„ APK Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯
          2. Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú¯ÙˆØ´ÛŒØŒ Ú¯Ø²ÛŒÙ†Ù‡ Ù†ØµØ¨ Ø§Ø² Ù…Ù†Ø§Ø¨Ø¹ Ù†Ø§Ø´Ù†Ø§Ø³ Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯
          3. ÙØ§ÛŒÙ„ APK Ø±Ø§ Ù†ØµØ¨ Ú©Ù†ÛŒØ¯
        files: bin/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
