name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: ğŸ“ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ğŸ“¦ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git zip unzip \
          openjdk-17-jdk \
          python3-pip python3-venv \
          autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev \
          libncursesw5-dev cmake \
          libffi-dev libssl-dev

    - name: ğŸ”§ Install Buildozer and Cython
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython==0.29.36

    - name: âœ… Accept Android SDK licenses
      run: |
        mkdir -p ~/.android
        echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > ~/.android/licenses/android-sdk-license
        echo "d56f5187479451e5792070366a5e903d62325516" > ~/.android/licenses/android-sdk-license
        echo "84831b94d134096996d9c67be85a9ac578393a57" > ~/.android/licenses/android-sdk-license

    - name: ğŸ—ï¸ Build APK with Buildozer
      run: |
        # ØªÙ†Ø¸ÛŒÙ… Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ
        export BUILDOZER_ANDROID_ACCEPT_LICENSES=yes
        export P4A_RELEASE_KEYSTORE_PASSWD=dummy
        export P4A_RELEASE_KEYALIAS_PASSWD=dummy
        
        # Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø´â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
        rm -rf .buildozer bin
        
        # Ø³Ø§Ø®Øª APK Ø¨Ø§ log level Ø¨Ø§Ù„Ø§
        buildozer -v android debug 2>&1 | tee build.log
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯Ù† build
        if [ -f bin/*.apk ]; then
          echo "âœ… APK built successfully!"
          ls -la bin/
        else
          echo "âŒ APK build failed!"
          tail -100 build.log
          exit 1
        fi

    - name: ğŸ“¤ Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: grade-predictor-apk
        path: bin/*.apk
        if-no-files-found: error
        retention-days: 7

    - name: ğŸ·ï¸ Create GitHub Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        files: bin/*.apk
        draft: false
        prerelease: false
