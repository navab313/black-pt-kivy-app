name: ğŸ—ï¸ Build Android APK with Buildozer

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build-android:
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    
    env:
      # ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø­ÛŒØ§ØªÛŒ Ø¨Ø±Ø§ÛŒ Buildozer
      BUILDOZER_ANDROID_ACCEPT_LICENSES: yes
      P4A_RELEASE_KEYSTORE_PASSWD: dummy_password
      P4A_RELEASE_KEYALIAS_PASSWD: dummy_password
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      NDK_VERSION: 25b
      
    steps:
    # Ù…Ø±Ø­Ù„Ù‡ 1: Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # Ù…Ø±Ø­Ù„Ù‡ 2: ØªÙ†Ø¸ÛŒÙ… Ù¾Ø§ÛŒØªÙˆÙ†
    - name: ğŸ Setup Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    # Ù…Ø±Ø­Ù„Ù‡ 3: Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…
    - name: ğŸ“¦ Install system dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          git wget curl unzip zip \
          openjdk-17-jdk \
          python3-pip python3-venv python3-dev \
          autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev libncursesw5-dev \
          libtinfo5 cmake ninja-build \
          libffi-dev libssl-dev sqlite3 \
          libjpeg-dev libfreetype6-dev \
          libgstreamer1.0-dev \
          g++-multilib

    # Ù…Ø±Ø­Ù„Ù‡ 4: Ù†ØµØ¨ Buildozer Ùˆ Cython
    - name: ğŸ”§ Install Buildozer and dependencies
      run: |
        python -m pip install --upgrade pip wheel setuptools
        pip install --upgrade \
          buildozer==1.5.0 \
          cython==0.29.36 \
          virtualenv \
          platformdirs

    # Ù…Ø±Ø­Ù„Ù‡ 5: ØªÙ†Ø¸ÛŒÙ… Android SDK Ùˆ Ù¾Ø°ÛŒØ±Ø´ Ù…Ø¬ÙˆØ²Ù‡Ø§
    - name: ğŸ¤– Setup Android SDK and accept licenses
      run: |
        # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ù„Ø§Ø²Ù…
        mkdir -p ~/.android
        mkdir -p ~/.android/licenses
        
        # Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ Ù…Ø¬ÙˆØ²Ù‡Ø§
        cat > ~/.android/licenses/android-sdk-license << EOF
        8933bad161af4178b1185d1a37fbf41ea5269c55
        d56f5187479451e5792070366a5e903d62325516
        84831b94d134096996d9c67be85a9ac578393a57  
        601085b94cd77f0b54ff86406957099ebe79c4d6
        24333f8a63b6825ea9c5514f83c2829b004d1fee
        EOF

        echo "Android licenses accepted"

    # Ù…Ø±Ø­Ù„Ù‡ 6: Ø¯Ø§Ù†Ù„ÙˆØ¯ Android SDK Ùˆ NDK
    - name: ğŸ“¥ Download Android SDK and NDK
      run: |
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ command line tools
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
        mkdir -p $ANDROID_HOME/cmdline-tools
        unzip -q cmdline-tools.zip -d $ANDROID_HOME/cmdline-tools
        mv $ANDROID_HOME/cmdline-tools/cmdline-tools $ANDROID_HOME/cmdline-tools/latest
        rm cmdline-tools.zip
        
        # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ PATH
        echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
        
        # Ù†ØµØ¨ platform tools Ùˆ build tools
        yes | sdkmanager --sdk_root=$ANDROID_HOME "platform-tools" "platforms;android-33"
        yes | sdkmanager --sdk_root=$ANDROID_HOME "build-tools;34.0.0"
        
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ NDK
        wget -q https://dl.google.com/android/repository/android-ndk-r25b-linux.zip -O ndk.zip
        unzip -q ndk.zip -d $ANDROID_HOME
        mv $ANDROID_HOME/android-ndk-r25b $ANDROID_HOME/ndk/$NDK_VERSION
        rm ndk.zip
        
        echo "Android SDK and NDK installed successfully"

    # Ù…Ø±Ø­Ù„Ù‡ 7: Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø´â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
    - name: ğŸ§¹ Clean previous builds
      run: |
        rm -rf .buildozer bin __pycache__ *.pyc
        echo "Previous builds cleaned"

    # Ù…Ø±Ø­Ù„Ù‡ 8: Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ
    - name: ğŸ” Check essential files
      run: |
        echo "Checking project structure..."
        
        # Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ
        REQUIRED_FILES=("main.py" "buildozer.spec")
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ Error: $file not found!"
            exit 1
          else
            echo "âœ… $file exists"
          fi
        done
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ
        REQUIRED_DIRS=("data" "fonts")
        for dir in "${REQUIRED_DIRS[@]}"; do
          if [ ! -d "$dir" ]; then
            echo "âš ï¸ Warning: $dir directory not found, creating..."
            mkdir -p "$dir"
          fi
        done
        
        echo "Project structure is ready"

    # Ù…Ø±Ø­Ù„Ù‡ 9: Ø³Ø§Ø®Øª APK Ø¨Ø§ Buildozer
    - name: ğŸ—ï¸ Build APK with Buildozer
      run: |
        echo "ğŸš€ Starting Buildozer build process..."
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ù„Ø§Ú¯ ÙØ§ÛŒÙ„
        LOG_FILE="build.log"
        
        # Ø§Ø¬Ø±Ø§ÛŒ Buildozer Ø¨Ø§ Ù„Ø§Ú¯ Ú©Ø§Ù…Ù„
        set -o pipefail
        buildozer -v \
          android clean \
          android update \
          android debug 2>&1 | tee $LOG_FILE
        
        BUILD_STATUS=$?
        
        if [ $BUILD_STATUS -eq 0 ]; then
          echo "âœ… Buildozer completed successfully"
        else
          echo "âŒ Buildozer failed with status: $BUILD_STATUS"
          echo "=== Build Log Errors ==="
          grep -i "error\|fail\|exception" $LOG_FILE | head -20
          echo "=== Last 50 lines ==="
          tail -50 $LOG_FILE
          exit 1
        fi

    # Ù…Ø±Ø­Ù„Ù‡ 10: Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„ APK ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡
    - name: ğŸ“Š Verify APK file
      run: |
        echo "ğŸ” Verifying APK file..."
        
        APK_FILE=$(find bin -name "*.apk" -type f | head -1)
        
        if [ -z "$APK_FILE" ]; then
          echo "âŒ No APK file found in bin directory!"
          ls -la bin/ 2>/dev/null || echo "bin directory doesn't exist"
          exit 1
        fi
        
        echo "âœ… APK found: $APK_FILE"
        echo "ğŸ“ Size: $(du -h "$APK_FILE" | cut -f1)"
        echo "ğŸ“… Modified: $(date -r "$APK_FILE")"
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù…Ø¶Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
        if command -v apksigner &> /dev/null; then
          apksigner verify --verbose "$APK_FILE" && echo "âœ… APK signature verified"
        fi

    # Ù…Ø±Ø­Ù„Ù‡ 11: Ø¢Ù¾Ù„ÙˆØ¯ APK Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Artifact
    - name: ğŸ“¤ Upload APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: grade-predictor-apk
        path: bin/*.apk
        if-no-files-found: error
        retention-days: 30
        overwrite: true

    # Ù…Ø±Ø­Ù„Ù‡ 12: Ø¢Ù¾Ù„ÙˆØ¯ Ù„Ø§Ú¯ Ø³Ø§Ø®Øª
    - name: ğŸ“ Upload build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          build.log
          .buildozer/**/*.log
        retention-days: 7
        if-no-files-found: ignore

    # Ù…Ø±Ø­Ù„Ù‡ 13: Ø§ÛŒØ¬Ø§Ø¯ Release Ø¯Ø± GitHub (ÙÙ‚Ø· Ø¯Ø± main/master)
    - name: ğŸ·ï¸ Create GitHub Release
      if: success() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }} - ${{ github.event.head_commit.message }}
        body: |
          ### ğŸš€ Grade Predictor APK
          
          **Ø³Ø§Ø®Øª Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² APK Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯**
          
          - **Ø´Ù…Ø§Ø±Ù‡ Ø³Ø§Ø®Øª:** ${{ github.run_number }}
          - **Ú©Ø§Ù…ÛŒØª:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          - **ØªØ§Ø±ÛŒØ® Ø³Ø§Ø®Øª:** $(date +'%Y-%m-%d %H:%M:%S')
          - **Ø´Ø§Ø®Ù‡:** ${{ github.ref_name }}
          
          ### ğŸ“± Ù†ØµØ¨
          1. ÙØ§ÛŒÙ„ APK Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯
          2. Ø¯Ø± Ú¯ÙˆØ´ÛŒ Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ØŒ Ø¨Ù‡ Settings â†’ Security Ø¨Ø±ÙˆÛŒØ¯
          3. Ú¯Ø²ÛŒÙ†Ù‡ "Unknown Sources" Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯
          4. ÙØ§ÛŒÙ„ APK Ø±Ø§ Ù†ØµØ¨ Ú©Ù†ÛŒØ¯
          
          ### ğŸ”§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙÙ†ÛŒ
          - Buildozer: 1.5.0
          - Python: 3.10
          - Android SDK: 33
          - Android NDK: 25b
          - Architecture: arm64-v8a
          
          ### ğŸ“„ ØªØºÛŒÛŒØ±Ø§Øª
          ${{ github.event.head_commit.message }}
          
        files: bin/*.apk
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Ù…Ø±Ø­Ù„Ù‡ 14: Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙÙ‚ÛŒØª
    - name: ğŸ”” Notify success
      if: success()
      run: |
        echo "ğŸ‰ Build completed successfully!"
        echo "ğŸ“¦ APK is ready for download"
        echo "ğŸ‘‰ Check the 'Artifacts' section or 'Releases' tab"

    # Ù…Ø±Ø­Ù„Ù‡ 15: Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø´Ú©Ø³Øª
    - name: ğŸš¨ Notify failure
      if: failure()
      run: |
        echo "âŒ Build failed!"
        echo "Please check the build logs for details"
        echo "Common issues:"
        echo "1. Missing requirements in buildozer.spec"
        echo "2. Android SDK/NDK issues"
        echo "3. Missing files (main.py, fonts, etc.)"
