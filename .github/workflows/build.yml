name: Build Android APK/AAB

on:
  push:
    # Ø§Ø¬Ø±Ø§ Ù‡Ù†Ú¯Ø§Ù… Push Ø¨Ù‡ Ø´Ø§Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
    branches: [ main, master ]
  pull_request:
    # Ø§Ø¬Ø±Ø§ Ù‡Ù†Ú¯Ø§Ù… Pull Request Ø¨Ù‡ Ø´Ø§Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
    branches: [ main, master ]
  workflow_dispatch:  # Ø§Ø¬Ø§Ø²Ù‡ Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ

jobs:
  build:
    # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø§ÙˆØ¨ÙˆÙ†ØªÙˆ
    runs-on: ubuntu-latest
    # ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø­ÛŒØ·ÛŒ Ø¨Ø±Ø§ÛŒ P4A/Buildozer
    env:
      # Ø§ÙØ²Ø§ÛŒØ´ Ø²Ù…Ø§Ù† ØªØ§ÛŒÙ…â€ŒØ§ÙˆØª Ù¾Ø§ÛŒØªÙˆÙ† Ø¨Ø±Ø§ÛŒ Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§ÛŒ Ø³Ù†Ú¯ÛŒÙ† (Ù…Ø§Ù†Ù†Ø¯ cryptography)
      PYTHON_FOR_ANDROID_THREAD_TIMEOUT: 600
      # Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ú©Ø±Ø± Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§
      PYTHON_FOR_ANDROID_IGNORE_FATAL_ERRORS: 1
      
    steps:
    - name: ğŸ“ Checkout code
      uses: actions/checkout@v4 

    - name: ğŸ“¦ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ› ï¸ Install dependencies for Buildozer
      # Ù†ØµØ¨ Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ Ùˆ Buildozer Ø¨Ø±Ø§ÛŒ Ù…Ø­ÛŒØ· CI
      run: |
        sudo apt-get update
        # Ø­Ø°Ù libtinfo5 Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø²Ú¯Ø§Ø±ØªØ±
        sudo apt-get install -y git zip unzip openjdk-17-jdk python3-pip autoconf libtool pkg-config zlib1g-dev libncursesw5-dev cmake
        pip install buildozer

    - name: âš™ï¸ Set execution permissions
      run: chmod +x buildozer.spec

    # --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÙØ§Ø±Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Buildozer ---
    - name: ğŸ”¨ Run Buildozer (Debug Build)
      # Ø§Ø¬Ø±Ø§ÛŒ Buildozer Ø¨Ø±Ø§ÛŒ Ø¨ÛŒÙ„Ø¯ debug
      # Ø§Ø² Ø¢Ù†Ø¬Ø§ÛŒÛŒ Ú©Ù‡ Ø¯Ø± buildozer.spec Ø§Ø² Ù¾Ú† Ù…Ø­Ù„ÛŒ p4a.local_recipes Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³ØªØŒ
      # Ø§ÛŒÙ† Ø¨ÛŒÙ„Ø¯ Ø§Ø² Ù†Ø³Ø®Ù‡ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ pyjnius Ø´Ù…Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø®ÙˆØ§Ù‡Ø¯ Ú©Ø±Ø¯.
      run: buildozer android debug
      
    # --- Ø¢Ù¾Ù„ÙˆØ¯ Ø®Ø±ÙˆØ¬ÛŒ ---
    - name: â¬†ï¸ Upload APK artifact
      # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² V4 Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§ÛŒ Ù…Ù†Ø³ÙˆØ® Ø´Ø¯Ù†
      uses: actions/upload-artifact@v4 
      with:
        name: ${{ github.event.repository.name }}-${{ github.run_number }}-apk
        path: bin/*.apk
        
    - name: ğŸ“¦ Create GitHub Release
      # Ø§ÛŒÙ† Ú¯Ø§Ù… ÙØ§ÛŒÙ„ Ø¨ÛŒÙ„Ø¯ Ø´Ø¯Ù‡ Ø±Ø§ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø¨Ù‡ ØµÙØ­Ù‡ Release Ø¯Ø± Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ Ù…Ù†ØªÙ‚Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        files: bin/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
